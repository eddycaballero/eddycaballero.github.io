<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8">
        <title>Grappler</title>
        <!--<link rel="stylesheet" href="style.css">-->
        <script type="text/javascript" src="./phaser.min.js"></script>
        <script type="text/javascript" src="./levels/room1.js"></script>
        
        <script type="text/javascript">
            var game = new Phaser.Game(800, 500, Phaser.AUTO, '');
            
            
            var menu;
            var room1;
            var room2;
            var room3;
            var currentRoom = 1;
            var gameWon;
            var gameOver;
            
            var score = 0;
            var scoreText;
            var player;
            var enemies;
            var platforms;
            var goal;
            var line;
            
            var gameKeyboard;
            
            function objectIsEmpty(object){
                var name;

                for(name in object) {
                    return false;
                }
                
                return true;
            }
            
            function loadAssets(){
                
            }
            
            function createState(){
                
            }
            
            function updateGame(){
                
            }
            
            //UI
            UI = {
                healthBar:{
                    segments:[],
                    background:{},
                    displayHealth: function(){
                        for(var i = 0; i < this.segments.length; i++){
                            if(i*10 < player.health){
                                this.segments[i].frame = 0;
                            } else {
                                this.segments[i].frame = 1;
                            }
                        }
                    }
                }
            }
            
            //player
            player = {
                playerBody:{},
                attackBody:{},
                health: 100,
                maxHealth: 100,
                invincibilityTimer: 0,
                invincibilityFrames: 60,
                attackCooldown: 0,
                attackFrames: 0,
                airborne: false,
                playerDirection: 1,
                knockBack: false,
                
                moveLeft: function(velocity){
                    if(!objectIsEmpty(this.playerBody)){
                        this.playerBody.animations.play('left');
                        if(!this.grappleLatched && player.invincibilityTimer == 0){
                            this.playerBody.body.velocity.x = -velocity;
                        }
                        this.playerDirection = -1;
                    }
                },
                
                moveRight: function(velocity){
                    if(!objectIsEmpty(this.playerBody)){
                        this.playerBody.animations.play('right');
                        if(!this.grappleLatched && player.invincibilityTimer == 0){
                            this.playerBody.body.velocity.x = velocity;
                        }
                        this.playerDirection = 1;
                    }
                },
                
                jump: function(velocity){
                    if(!objectIsEmpty(this.playerBody)){
                        if(this.grappleLatched && player.invincibilityTimer == 0){
                            this.unlatchHook(velocity);
                        }
                        if(!this.airborne){
                            this.playerBody.body.velocity.y = -velocity;
                            this.airborne = true;
                        }
                    }
                },
                
                rest: function(){
                    player.playerBody.frame = 4;
                    if(!player.reelingIn && player.invincibilityTimer == 0){
                        player.playerBody.body.velocity.x = 0;
                        player.playerBody.animations.stop();
                    }
                },
                
                attack: function(enemies){
                    if(!objectIsEmpty(this.playerBody)){
                        if(this.attackCooldown == 0){
                            var posX;
                            
                            this.attackFrames = 8;
                            this.attackCooldown = 16;
                            if(this.playerDirection == -1){
                                posX = this.playerBody.body.x - 25;
                            } else {
                                posX = this.playerBody.body.x + this.playerBody.body.width;
                            }

                            this.attackBody = game.add.sprite(posX, this.playerBody.body.y + this.playerBody.body.height - 35, 'slashWave',0);
                            if(this.playerDirection == -1){
                                this.attackBody.frame = 0;
                            } else {
                                this.attackBody.frame = 1;
                            }
                            
                            game.physics.arcade.enableBody(this.attackBody);
                            game.physics.arcade.overlap(this.attackBody, enemies, this.attackEnemy, null, this);
                        }
                    }
                },
                
                attackEnemy: function(attack, enemy){
                    enemy.takeDamage();
                },
                
                takeDamage: function(player,enemy){
                    if(this.invincibilityTimer == 0){
                        this.invincibilityTimer = this.invincibilityFrames;
                        this.health -= 10;
                        this.reeledIn = true;
                        this.unlatchHook(50);

                        var deltaXPoint;
                        var deltaYPoint;
                        
                        if(this.playerBody.body.x + this.playerBody.body.halfWidth - enemy.body.x - enemy.body.halfWidth < 0){
                            deltaXPoint = this.playerBody.body.x - 40;
                        } else {
                            deltaXPoint = this.playerBody.body.x + 40;
                        }
                        
                        deltaYPoint = this.playerBody.body.y - 10;
                        
                        line.lineStyle(2,0xff0000,1);
                        line.moveTo(this.playerBody.body.x + this.playerBody.body.halfWidth, this.playerBody.body.y + this.playerBody.body.halfHeight);
                        line.lineTo(deltaXPoint, deltaYPoint);
                        
                        this.playerBody.body.velocity.x = 0;
                        this.playerBody.body.velocity.y = 0;
                        game.physics.arcade.moveToXY(this.playerBody,deltaXPoint,deltaYPoint,60);
                    }
                },
                
                increaseScore: function(score){
                    this.score += score;
                },
                
                checkAttacking: function(){
                    if(this.attackCooldown > 0){
                        this.attackCooldown -= 1;
                    }
                            
                    if(!objectIsEmpty(this.attackBody)){
                        if(this.attackFrames > 0){
                            this.attackFrames -= 1;
                        } else {
                            player.attackBody.kill();
                            player.attackBody = {};
                        }
                    }
                },
                
                checkAirborne: function(){
                    if(this.playerBody.body.touching.down){
                        this.airborne = false;
                    } else {
                        this.airborne = true;
                    }
                },
                
                invincibilityCountdown: function(){
                    if(this.invincibilityTimer > 0){
                        this.invincibilityTimer -= 1;
                    } else {
                        this.invincibilityTimer = 0;
                    }
                },
                
                //Properties
                grappleBody:{},
                reticule:{},
                grappleOut: false,
                grappleLatched: false,
                grappleTaut: false,
                grappleFrame: 0,
                reelingIn: false,
                reeledIn: false,
                maxLength: 300,
                reelVelocity: 500,
                cooldownTimer: 0,
                aimAngle: Math.PI/2,
                grappleNetAcceleration: {
                    x: 0,
                    y: 0
                },
                grappleGravity: {
                    x: 0,
                    y: 5
                },
                
                //Methods
                aimDown: function(degree){
                    if(this.aimAngle > 0){
                        this.aimAngle -= degree; 
                    } else {
                        this.aimAngle = 0;
                    }
                },
                
                aimUp: function(degree){
                    if(this.aimAngle < Math.PI){
                        this.aimAngle += degree; 
                    } else {
                        this.aimAngle = Math.PI;
                    }
                },
                    
                fireHook: function(velocity){
                    //fire hook in target direction until colliding with platform, obstacle or enemy
                    
                    if(!objectIsEmpty(this.grappleBody)){
                        if(!this.grappleOut){
                            this.grappleBody.body.velocity.x = (this.playerDirection * velocity * Math.sin(this.aimAngle))
                            this.grappleBody.body.velocity.y = (velocity * Math.cos(this.aimAngle));
                            this.grappleOut = true;
                        }
                    }
                },
                
                checkTaut: function(){
                    var hookDistance;
                    
                    if(!objectIsEmpty(this.grappleBody)){
                        hookDistance = this.calculateHookDistance();
                        
                        if(!this.grappleLatched){ 
                            
                            if(hookDistance >= this.maxLength){
                                this.grappleTaut = true;
                                this.grappleBody.body.x = this.playerBody.body.x + (this.grappleBody.body.x - this.playerBody.body.x)/this.calculateHookDistance() * this.maxLength;
                                this.grappleBody.body.y = this.playerBody.body.y + (this.grappleBody.body.y - this.playerBody.body.y)/this.calculateHookDistance() * this.maxLength;
                            } else {
                                this.grappleTaut = false;
                            }
                        } else {
                            if(hookDistance >= this.maxLength){
                                this.grappleTaut = true;
                                this.playerBody.body.x = this.grappleBody.body.x + (this.playerBody.body.x - this.grappleBody.body.x)/this.calculateHookDistance() * this.maxLength;
                                this.playerBody.body.y = this.grappleBody.body.y + (this.playerBody.body.y - this.grappleBody.body.y)/this.calculateHookDistance() * this.maxLength;
                            } else {
                                this.grappleTaut = false;
                            }
                        }
                    }
                },
                
                calculateHookDistance: function(){
                    var distance = Math.sqrt(Math.pow(this.playerBody.body.x + this.playerBody.body.halfWidth - this.grappleBody.body.x - this.grappleBody.body.halfWidth,2) + Math.pow(this.playerBody.body.y + this.playerBody.body.halfHeight - this.grappleBody.body.y - this.grappleBody.body.halfHeight,2));
                    
                    return distance;
                },
                
                calculateDistance: function(obj1,obj2){
                    var distance = Math.sqrt(Math.pow(obj1.body.center.x - obj2.body.center.x,2) + Math.pow(obj1.body.center.y - obj2.body.center.y,2));
                    
                    return distance;
                },
                
                reelIn: function(){
                    //increase player acceleration toward hook until maximum velocity is achieved
                    
                    if(!objectIsEmpty(this.playerBody) && !objectIsEmpty(this.grappleBody)){
                        if(this.grappleOut && this.grappleLatched){
                            this.playerBody.body.velocity.x = (this.grappleBody.body.x - this.playerBody.body.x -this.playerBody.body.halfWidth)/this.calculateHookDistance() * this.reelVelocity;
                
                            this.playerBody.body.velocity.y = (this.grappleBody.body.y - this.playerBody.body.y - this.playerBody.body.halfHeight)/this.calculateHookDistance() * this.reelVelocity;
                            
                            if(this.playerBody.body.deltaAbsX() < 1 && this.playerBody.body.deltaAbsY() < 1 && this.reelingIn){
                                this.reeledIn = true;
                            } 
                            
                            this.reelingIn = true;
                        }
                    }
                },
                
                latchHook: function(hook,platform){
                    //hook latches onto a platform or object and begins to pull in player
                    
                    this.grappleLatched = true;
                    this.grappleBody.body.velocity.x = 0;
                    this.grappleBody.body.velocity.y = 0;
                    this.reelIn();
                },
            
                unlatchHook: function(velocity){
                    //stops hook
                    
                    if(this.reeledIn){
                        this.reelingIn = false;
                        this.reeledIn = false;
                        this.grappleLatched = false;
                        this.grappleOut = false;
                        this.grappleBody.body.x = this.playerBody.body.x + this.playerBody.body.halfWidth;
                        this.grappleBody.body.y = this.playerBody.body.y + this.playerBody.body.halfHeight;
                        this.playerBody.body.velocity.y = -velocity;
                    }
                },
                
                redrawReticule: function(){
                    if(!objectIsEmpty(this.reticule)){
                        this.reticule.x = this.playerBody.body.x + this.playerBody.body.halfWidth + (this.playerDirection * 50 * Math.sin(this.aimAngle)) - this.reticule.width/2;
                        this.reticule.y = this.playerBody.body.y + this.playerBody.body.halfHeight + (50 * Math.cos(this.aimAngle)) - this.reticule.height/2;
                    }
                },
                
                repositionHook: function(){
                    var tension;
                    
                    if(!objectIsEmpty(this.grappleBody)){
                        line.clear();
                        
                        if(!this.grappleOut){
                            this.grappleBody.body.x = this.playerBody.body.x + this.playerBody.body.halfWidth;
                            this.grappleBody.body.y = this.playerBody.body.y + this.playerBody.body.halfHeight;
                        } else {
                            if(!this.grappleLatched){
                                
                                if(!this.grappleTaut){
                                    this.grappleNetAcceleration = this.grappleGravity;
                                } else {
                                    tension = {
                                        x: (this.playerBody.body.x - this.grappleBody.body.x)/this.calculateHookDistance() * this.grappleGravity.y,
                                        y: (this.playerBody.body.y - this.grappleBody.body.y)/this.calculateHookDistance() * this.grappleGravity.y
                                    };   
                                    
                                    this.grappleNetAcceleration = this.addVectors([this.grappleGravity,tension]);
                                }
                                
                                this.grappleBody.body.velocity.x += this.grappleNetAcceleration.x;
                                this.grappleBody.body.velocity.y += this.grappleNetAcceleration.y;
                                
                                //Resistance to slow hook
                                if(Math.abs(this.grappleBody.body.velocity.x) > 0.1){
                                    if(this.grappleBody.body.velocity.x < 0){
                                        this.grappleBody.body.velocity.x += Math.min(Math.abs(this.grappleBody.body.velocity.x)/10, 1);
                                    } else {
                                        this.grappleBody.body.velocity.x -= Math.min(Math.abs(this.grappleBody.body.velocity.x)/10, 1);
                                    }
                                } else {
                                    this.grappleBody.body.velocity.x = 0;
                                }
                                
                                if(Math.abs(this.grappleBody.body.velocity.y) > 0.1){
                                    if(this.grappleBody.body.velocity.y < 0){
                                        this.grappleBody.body.velocity.y += Math.min(Math.abs(this.grappleBody.body.velocity.y)/10, 2);
                                    } else {
                                        this.grappleBody.body.velocity.y -= Math.min(Math.abs(this.grappleBody.body.velocity.y)/10, 2);
                                    }
                                } else {
                                    this.grappleBody.body.velocity.y = 0;
                                }
                                
                            }
                            
                            line.lineStyle(2,0x000000,1);
                            line.moveTo(this.playerBody.body.x + this.playerBody.body.halfWidth, this.playerBody.body.y + this.playerBody.body.halfHeight);
                            line.lineTo(this.grappleBody.body.x + this.grappleBody.body.halfWidth, this.grappleBody.body.y + this.grappleBody.body.halfHeight);
                        }
                    }
                },
                
                reset: function(){
                    this.playerBody={};
                    this.attackBody={};
                    this.invincibilityTimer= 0;
                    this.invincibilityFrames= 40;
                    this.attackCooldown= 0;
                    this.attackFrames= 0;
                    this.airborne= false;
                    this.playerDirection= 1;
                    this.grappleBody={};
                    this.reticule={};
                    this.grappleOut= false;
                    this.grappleLatched= false;
                    this.grappleTaut= false;
                    this.grappleFrame= 0;
                    this.reelingIn= false;
                    this.reeledIn= false;
                    this.maxLength= 250;
                    this.reelVelocity= 500;
                    this.cooldownTimer= 0;
                    this.grappleNetAcceleration= {
                        x: 0,
                        y: 0
                    }; 
                    this.grappleGravity= {
                        x: 0,
                        y: 5
                    };
                },
                
                addVectors(vectors){
                    var returnVector = {
                        x: 0,
                        y: 0
                    };
                    
                    for(var i = 0; i < vectors.length; i++){
                        returnVector.x += vectors[i].x;
                        returnVector.y += vectors[i].y;
                    }
                    
                    return returnVector;
                }
            }
            

            menu = { 
                preload: function() {
                    
                },

                create: function() {
                    
                },

                update: function() {

                }
            };
            
            room1 = { 
                preload: function() {
                    game.load.image('background','./assets/img/game_background.png');
                    game.load.image('enemy','./assets/sprites/baddie.png');
                    game.load.image('platforms','./assets/img/platform.png');
                    game.load.image('aimingReticule','./assets/sprites/reticule.png');
                    game.load.spritesheet('player','./assets/sprites/dude.png', 32, 48);
                    game.load.spritesheet('grapplingHook','./assets/sprites/grapple.png',11,12);
                    game.load.spritesheet('slashWave','./assets/sprites/slash.png',25,35);
                    game.load.spritesheet('enemy','./assets/sprites/baddie.png',32, 32);
                    game.load.image('flag','./assets/sprites/flag.png',32,44);
                    game.load.image('healthBar','./assets/ui/healthbar_empty.png');
                    game.load.spritesheet('healthSegment','./assets/ui/health_segment.png',9,16);
                    game.load.image('blankspace','./assets/img/empty.png');
                },

                create: function() {
                    gameCamera = game.camera;
                    game.world.setBounds(0, 0, 3600, 1000);
                    
                    gameKeyboard = game.input.keyboard.createCursorKeys();
                    gameKeyboard.space = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                    gameKeyboard.a_key = game.input.keyboard.addKey(Phaser.Keyboard.A);
                    gameKeyboard.s_key = game.input.keyboard.addKey(Phaser.Keyboard.S);
                    game.physics.startSystem(Phaser.Physics.ARCADE);

                    //background
                    background = game.add.sprite(0, 0, 'background');
                    background.width = 800;
                    background.height = 500;
                    background.fixedToCamera = true;

                    //platforms
                    platforms = game.add.group();
                    platforms.enableBody = true;
                    exits = game.add.group();
                    exits.enableBody = true;
                    
                    function createPlatform(x,y,xScale,yScale){
                        platform = platforms.create(x,y,'platforms');
                        platform.scale.setTo(xScale,yScale);
                        platform.body.immovable = true;
                        return platform;
                    }
                    
                    function createExit(x,y,xScale,yScale,roomNumber){
                        exit = exits.create(x,y,'blankspace');
                        exit.scale.setTo(xScale,yScale);
                        exit.body.immovable = true;
                        exit.roomNumber = roomNumber;
                        return exit;
                    }

                    createPlatform(0, game.world.height - 50, 36, 1);
                    createPlatform(0,0,1,0.25)
                    createPlatform(250,0, 33.5, 0.25);
                    createPlatform(0,0,0.25,10);
                    createPlatform(game.world.width - 25,0,0.25,2);
                    createPlatform(game.world.width - 25,450,0.25,5.5);
                    createPlatform(0,450,2, 3);
                    createPlatform(300,250,1, 0.25);
                    createPlatform(1600,700,0.45,1.25);
                    createPlatform(2030,450,15.70,0.5);
                    tilt = createPlatform(1600,700,5,0.5);
                    createPlatform(2030,450,0.5,2.5);
                    createPlatform(2550, 650, 0.3, 3.5);
                    createPlatform(2900, 450, 0.3, 3);
                    createPlatform(3100, 700, 5, 0.3);
                    //tilt.angle -= 30;
                    
                    //room2 exit
                    room2Exit = createExit(100,0,1.5,0.15,2);
                    
                    
                    //enemies
                    enemies = game.add.group();
                    enemies.enableBody = true;
                    enemies.collideWorldBounds = true;
                    
                    enemyPositions = [{}]

                    for(var i = 0; i < 2; i++){
                        enemy = enemies.create(500+i*150, 100,'enemy');
                        enemy.body.gravity.y = 300;
                        enemy.wanderTimer = 0;
                        enemy.pauseTimer = 0;
                        enemy.takeDamage = function(){
                            this.kill();
                            score += 100;
                        }
                        enemy.animations.add('left', [0, 1], 10, true);
                        enemy.animations.add('right', [2,3], 10, true);
                        enemy.direction = -1;
                        enemy.wander = function(){

                            if(this.wanderTimer == 0){
                                this.body.velocity.x = 0;
                                this.animations.stop();

                                if(this.direction < 0){
                                    this.frame = 1;
                                } else {
                                    this.frame = 2;
                                }

                                if(this.pauseTimer > 50){
                                    if(Math.random() < 0.1){
                                        this.wanderTimer = 51 + Math.floor(Math.random() * 50);
                                        this.body.velocity.x -= 20;
                                        this.animations.play('left');
                                        this.direction = -1;
                                    } else if(Math.random() > 0.9){
                                        this.wanderTimer = 51 + Math.floor(Math.random() * 50);
                                        this.body.velocity.x += 20;
                                        this.animations.play('right');
                                        this.direction = 1;
                                    }
                                    this.pauseTimer = 0;
                                } else {
                                    this.pauseTimer++;
                                }
                            } else {
                                this.wanderTimer--;
                            }
                        }

                    }

                    line = game.add.graphics(0,0);
                    
                    //player
                    player.playerBody = game.add.sprite(32, 100, 'player',0);
                    game.physics.arcade.enableBody(player.playerBody);
                    player.grappleBody = game.add.sprite(50,100,'grapplingHook',0);
                    game.physics.arcade.enableBody(player.grappleBody);

                    player.reticule = game.add.sprite(player.playerBody.body.x + player.playerBody.body.halfWidth + (50 * Math.sin(player.aimAngle)), player.playerBody.body.y + player.playerBody.body.halfHeight + (50 * Math.cos(player.aimAngle)),'aimingReticule',0);

                    player.playerBody.body.gravity.y = 300;
                    player.grappleBody.body.maxVelocity = 300;
                    player.playerBody.body.collideWorldBounds = true;
                    player.grappleBody.body.collideWorldBounds = true;

                    player.playerBody.animations.add('left', [0, 1, 2, 3], 10, true);
                    player.playerBody.animations.add('right', [5, 6, 7, 8], 10, true);

                    //ui
                    instruction = game.add.text(200, 16, '', { fontSize: '16px', fill: '#000' });
                    instruction.text = "left and right arrows to move, 'space' to jump,\nup and down arrows to aim grapple,\n'a' to attack , 's' to fire grapple\nCapture the flag to progress";
                    
                    
                    scoreText = game.add.text(16, 16, 'score: 0 pts', { fontSize: '16px', fill: '#000' });
                    scoreText.fixedToCamera = true;
                    healthText = game.add.text(540, 16, 'health:', { fontSize: '16px', fill: '#000' });
                    healthText.fixedToCamera = true;
                    
                    UI.healthBar.background = game.add.sprite(600, 16, 'healthBar');
                    UI.healthBar.background.fixedToCamera = true;
                    for(var i = 0; i < player.maxHealth/10; i++){
                        UI.healthBar.segments[i] = game.add.sprite(602 + (i * 9), 18, 'healthSegment',0);
                        UI.healthBar.segments[i].fixedToCamera = true;
                    }
                    
                    gameCamera.follow(player.playerBody,Phaser.Camera.FOLLOW_LOCKON,0.5,0.5);
                },

                update: function() {
                    var nextRoom = 0;
                    game.physics.arcade.collide(player.playerBody, platforms);
                    game.physics.arcade.collide(enemies, platforms);
                    game.physics.arcade.overlap(player.grappleBody, platforms, player.latchHook,null,player);
                    game.physics.arcade.overlap(player.playerBody,enemies, player.takeDamage ,null,player);
                    game.physics.arcade.overlap(player.playerBody,exits,function(player,exit){nextRoom = exit.roomNumber;},null,this);
                    
                    while(nextRoom == 0){
                        enemies.forEach(function(enemy){
                            enemy.wander();
                        },this);

                        player.redrawReticule();
                        player.checkAirborne();
                        player.repositionHook();
                        player.checkAttacking();
                        player.invincibilityCountdown();

                        if(player.grappleOut) {
                            player.checkTaut();
                        }

                        if(gameKeyboard.left.isDown){
                            player.moveLeft(100);
                        } else if(gameKeyboard.right.isDown){
                            player.moveRight(100);
                        } else {
                            player.rest();
                        }

                        if(gameKeyboard.up.isDown){
                            player.aimUp(Math.PI/32);
                        } else if(gameKeyboard.down.isDown){
                            player.aimDown(Math.PI/32);
                        }

                        if(gameKeyboard.space.isDown){
                            player.jump(200);
                        }

                        if(gameKeyboard.a_key.isDown){
                            player.attack(enemies);
                        }

                        if(gameKeyboard.s_key.isDown){
                            player.fireHook(500);
                        }

                        scoreText.text = 'score: ' + score + ' pts';
                        UI.healthBar.displayHealth();
                        return;
                    }
                    
                    player.reset();
                    game.state.start('room' + nextRoom);
                }
            };
            
            room2 = { 
                preload: function() {
                    game.load.image('background','./assets/img/game_background.png');
                    game.load.image('enemy','./assets/sprites/baddie.png');
                    game.load.image('platforms','./assets/img/platform.png');
                    game.load.image('aimingReticule','./assets/sprites/reticule.png');
                    game.load.spritesheet('player','./assets/sprites/dude.png', 32, 48);
                    game.load.spritesheet('grapplingHook','./assets/sprites/grapple.png',11,12);
                    game.load.spritesheet('slashWave','./assets/sprites/slash.png',25,35);
                    game.load.spritesheet('enemy','./assets/sprites/baddie.png',32, 32);
                    game.load.image('flag','./assets/sprites/flag.png',32,44);
                    game.load.image('healthBar','./assets/ui/healthbar_empty.png');
                    game.load.spritesheet('healthSegment','./assets/ui/health_segment.png',9,16);
                    game.load.image('blankspace','./assets/img/empty.png');
                },

                create: function() {
                    gameCamera = game.camera;
                    game.world.setBounds(0, 0, 1600, 900);
                    
                    gameKeyboard = game.input.keyboard.createCursorKeys();
                    gameKeyboard.space = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                    gameKeyboard.a_key = game.input.keyboard.addKey(Phaser.Keyboard.A);
                    gameKeyboard.s_key = game.input.keyboard.addKey(Phaser.Keyboard.S);
                    game.physics.startSystem(Phaser.Physics.ARCADE);

                    //background
                    background = game.add.sprite(0, 0, 'background');
                    background.width = 800;
                    background.height = 500;
                    background.fixedToCamera = true;

                    //platforms
                    platforms = game.add.group();
                    platforms.enableBody = true;
                    exits = game.add.group();
                    exits.enableBody = true;
                    
                    function createPlatform(x,y,xScale,yScale){
                        platform = platforms.create(x,y,'platforms');
                        platform.scale.setTo(xScale,yScale);
                        platform.body.immovable = true;
                        return platform;
                    }
                    
                    function createExit(x,y,xScale,yScale,roomNumber){
                        exit = exits.create(x,y,'blankspace');
                        exit.scale.setTo(xScale,yScale);
                        exit.body.immovable = true;
                        exit.roomNumber = roomNumber;
                        return exit;
                    }

                    createPlatform(0, game.world.height - 50, 6, 1);
                    createPlatform(780, game.world.height - 50, 9, 1);
                    createPlatform(0,0,8,0.25)
                    createPlatform(900,0,7,0.25);
                    createPlatform(0,0,0.25,10);
                    createPlatform(game.world.width - 25,0,0.25,10);
                    createPlatform(0,400,2,0.3);
                    createPlatform(750,200,2,0.3);
                    createPlatform(1400,625,2,0.3);
                    createPlatform(450,400,8.5,0.3);
                    createPlatform(600,400,0.3,5);
                    
                    room1Exit = createExit(630,game.world.height - 30,1.5,0.3,1);
                    room3Exit = createExit(800,0,1,0.15,3);
                    
                    //enemies
                    enemies = game.add.group();
                    enemies.enableBody = true;
                    enemies.collideWorldBounds = true;

                    for(var i = 0; i < 2; i++){
                        enemy = enemies.create(500+i*150, 100,'enemy');
                        enemy.body.gravity.y = 300;
                        enemy.wanderTimer = 0;
                        enemy.pauseTimer = 0;
                        enemy.takeDamage = function(){
                            this.kill();
                            score += 100;
                        }
                        enemy.animations.add('left', [0, 1], 10, true);
                        enemy.animations.add('right', [2,3], 10, true);
                        enemy.direction = -1;
                        enemy.wander = function(){

                            if(this.wanderTimer == 0){
                                this.body.velocity.x = 0;
                                this.animations.stop();

                                if(this.direction < 0){
                                    this.frame = 1;
                                } else {
                                    this.frame = 2;
                                }

                                if(this.pauseTimer > 50){
                                    if(Math.random() < 0.1){
                                        this.wanderTimer = 51 + Math.floor(Math.random() * 50);
                                        this.body.velocity.x -= 20;
                                        this.animations.play('left');
                                        this.direction = -1;
                                    } else if(Math.random() > 0.9){
                                        this.wanderTimer = 51 + Math.floor(Math.random() * 50);
                                        this.body.velocity.x += 20;
                                        this.animations.play('right');
                                        this.direction = 1;
                                    }
                                    this.pauseTimer = 0;
                                } else {
                                    this.pauseTimer++;
                                }
                            } else {
                                this.wanderTimer--;
                            }
                        }

                    }

                    line = game.add.graphics(0,0);
                    
                    //player
                    player.playerBody = game.add.sprite(32, 100, 'player',0);
                    game.physics.arcade.enableBody(player.playerBody);
                    player.grappleBody = game.add.sprite(50,100,'grapplingHook',0);
                    game.physics.arcade.enableBody(player.grappleBody);

                    player.reticule = game.add.sprite(player.playerBody.body.x + player.playerBody.body.halfWidth + (50 * Math.sin(player.aimAngle)), player.playerBody.body.y + player.playerBody.body.halfHeight + (50 * Math.cos(player.aimAngle)),'aimingReticule',0);

                    player.playerBody.body.gravity.y = 300;
                    player.grappleBody.body.maxVelocity = 300;
                    player.playerBody.body.collideWorldBounds = true;
                    player.grappleBody.body.collideWorldBounds = true;

                    player.playerBody.animations.add('left', [0, 1, 2, 3], 10, true);
                    player.playerBody.animations.add('right', [5, 6, 7, 8], 10, true);

                    //ui
                    scoreText = game.add.text(16, 16, 'score: 0 pts', { fontSize: '16px', fill: '#000' });
                    scoreText.fixedToCamera = true;
                    healthText = game.add.text(540, 16, 'health:', { fontSize: '16px', fill: '#000' });
                    healthText.fixedToCamera = true;
                    
                    UI.healthBar.background = game.add.sprite(600, 16, 'healthBar');
                    UI.healthBar.background.fixedToCamera = true;
                    for(var i = 0; i < player.maxHealth/10; i++){
                        UI.healthBar.segments[i] = game.add.sprite(602 + (i * 9), 18, 'healthSegment',0);
                        UI.healthBar.segments[i].fixedToCamera = true;
                    }
                    
                    gameCamera.follow(player.playerBody,Phaser.Camera.FOLLOW_LOCKON,0.5,0.5);
                },

                update: function() {
                    var nextRoom = 0;
                    game.physics.arcade.collide(player.playerBody, platforms);
                    game.physics.arcade.collide(enemies, platforms);
                    game.physics.arcade.overlap(player.grappleBody, platforms, player.latchHook,null,player);
                    game.physics.arcade.overlap(player.playerBody,enemies, player.takeDamage ,null,player);
                    game.physics.arcade.overlap(player.playerBody,exits,function(player,exit){nextRoom = exit.roomNumber;},null,this);
                    
                    while(nextRoom == 0){
                        enemies.forEach(function(enemy){
                            enemy.wander();
                        },this);

                        player.redrawReticule();
                        player.checkAirborne();
                        player.repositionHook();
                        player.checkAttacking();
                        player.invincibilityCountdown();

                        if(player.grappleOut) {
                            player.checkTaut();
                        }

                        if(gameKeyboard.left.isDown){
                            player.moveLeft(100);
                        } else if(gameKeyboard.right.isDown){
                            player.moveRight(100);
                        } else {
                            player.rest();
                        }

                        if(gameKeyboard.up.isDown){
                            player.aimUp(Math.PI/32);
                        } else if(gameKeyboard.down.isDown){
                            player.aimDown(Math.PI/32);
                        }

                        if(gameKeyboard.space.isDown){
                            player.jump(200);
                        }

                        if(gameKeyboard.a_key.isDown){
                            player.attack(enemies);
                        }

                        if(gameKeyboard.s_key.isDown){
                            player.fireHook(500);
                        }

                        scoreText.text = 'score: ' + score + ' pts';
                        UI.healthBar.displayHealth();
                        return;
                    }
                    
                    player.reset();
                    game.state.start('room' + nextRoom);
                }
            };
            
            room3 = { 
                preload: function() {
                    game.load.image('background','./assets/img/game_background.png');
                    game.load.image('enemy','./assets/sprites/baddie.png');
                    game.load.image('platforms','./assets/img/platform.png');
                    game.load.image('aimingReticule','./assets/sprites/reticule.png');
                    game.load.spritesheet('player','./assets/sprites/dude.png', 32, 48);
                    game.load.spritesheet('grapplingHook','./assets/sprites/grapple.png',11,12);
                    game.load.spritesheet('slashWave','./assets/sprites/slash.png',25,35);
                    game.load.spritesheet('enemy','./assets/sprites/baddie.png',32, 32);
                    game.load.image('flag','./assets/sprites/flag.png',32,44);
                    game.load.image('healthBar','./assets/ui/healthbar_empty.png');
                    game.load.spritesheet('healthSegment','./assets/ui/health_segment.png',9,16);
                    game.load.image('blankspace','./assets/img/empty.png');
                },

                create: function() {
                    gameCamera = game.camera;
                    game.world.setBounds(0, 0, 1500, 1100);
                    
                    gameKeyboard = game.input.keyboard.createCursorKeys();
                    gameKeyboard.space = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                    gameKeyboard.a_key = game.input.keyboard.addKey(Phaser.Keyboard.A);
                    gameKeyboard.s_key = game.input.keyboard.addKey(Phaser.Keyboard.S);
                    game.physics.startSystem(Phaser.Physics.ARCADE);

                    //background
                    background = game.add.sprite(0, 0, 'background');
                    background.width = 800;
                    background.height = 500;
                    background.fixedToCamera = true;

                    //platforms
                    platforms = game.add.group();
                    platforms.enableBody = true;
                    exits = game.add.group();
                    exits.enableBody = true;
                    
                    function createPlatform(x,y,xScale,yScale){
                        platform = platforms.create(x,y,'platforms');
                        platform.scale.setTo(xScale,yScale);
                        platform.body.immovable = true;
                        return platform;
                    }
                    
                    function createExit(x,y,xScale,yScale,roomNumber){
                        exit = exits.create(x,y,'blankspace');
                        exit.scale.setTo(xScale,yScale);
                        exit.body.immovable = true;
                        exit.roomNumber = roomNumber;
                        return exit;
                    }


                    createPlatform(0, game.world.height - 50, 13.75, 1);
                    createPlatform(0,0,7.5,0.25);
                    createPlatform(850,0,6.5,0.25);
                    createPlatform(0,0,0.25,11);
                    createPlatform(game.world.width - 25,0,0.25,11);
                    createPlatform(800,300,2,0.3);
                    createPlatform(350,550,2.5,0.3);
                    createPlatform(0,800,2,0.3);
                    createPlatform(700,700,0.3,4);
                    //tilt.angle -= 30;
                    
                    room2Exit = createExit(1375,game.world.height - 30, 1, 0.3,2);
                    
                    
                    //enemies
                    enemies = game.add.group();
                    enemies.enableBody = true;
                    enemies.collideWorldBounds = true;

                    for(var i = 0; i < 2; i++){
                        enemy = enemies.create(500+i*150, 100,'enemy');
                        enemy.body.gravity.y = 300;
                        enemy.wanderTimer = 0;
                        enemy.pauseTimer = 0;
                        enemy.takeDamage = function(){
                            this.kill();
                            score += 100;
                        }
                        enemy.animations.add('left', [0, 1], 10, true);
                        enemy.animations.add('right', [2,3], 10, true);
                        enemy.direction = -1;
                        enemy.wander = function(){

                            if(this.wanderTimer == 0){
                                this.body.velocity.x = 0;
                                this.animations.stop();

                                if(this.direction < 0){
                                    this.frame = 1;
                                } else {
                                    this.frame = 2;
                                }

                                if(this.pauseTimer > 50){
                                    if(Math.random() < 0.1){
                                        this.wanderTimer = 51 + Math.floor(Math.random() * 50);
                                        this.body.velocity.x -= 20;
                                        this.animations.play('left');
                                        this.direction = -1;
                                    } else if(Math.random() > 0.9){
                                        this.wanderTimer = 51 + Math.floor(Math.random() * 50);
                                        this.body.velocity.x += 20;
                                        this.animations.play('right');
                                        this.direction = 1;
                                    }
                                    this.pauseTimer = 0;
                                } else {
                                    this.pauseTimer++;
                                }
                            } else {
                                this.wanderTimer--;
                            }
                        }

                    }

                    line = game.add.graphics(0,0);
                    
                    //player
                    player.playerBody = game.add.sprite(32, 100, 'player',0);
                    game.physics.arcade.enableBody(player.playerBody);
                    player.grappleBody = game.add.sprite(50,100,'grapplingHook',0);
                    game.physics.arcade.enableBody(player.grappleBody);

                    player.reticule = game.add.sprite(player.playerBody.body.x + player.playerBody.body.halfWidth + (50 * Math.sin(player.aimAngle)), player.playerBody.body.y + player.playerBody.body.halfHeight + (50 * Math.cos(player.aimAngle)),'aimingReticule',0);

                    player.playerBody.body.gravity.y = 300;
                    player.grappleBody.body.maxVelocity = 300;
                    player.playerBody.body.collideWorldBounds = true;
                    player.grappleBody.body.collideWorldBounds = true;

                    player.playerBody.animations.add('left', [0, 1, 2, 3], 10, true);
                    player.playerBody.animations.add('right', [5, 6, 7, 8], 10, true);

                    //ui
                    scoreText = game.add.text(16, 16, 'score: 0 pts', { fontSize: '16px', fill: '#000' });
                    scoreText.fixedToCamera = true;
                    healthText = game.add.text(540, 16, 'health:', { fontSize: '16px', fill: '#000' });
                    healthText.fixedToCamera = true;
                    
                    UI.healthBar.background = game.add.sprite(600, 16, 'healthBar');
                    UI.healthBar.background.fixedToCamera = true;
                    for(var i = 0; i < player.maxHealth/10; i++){
                        UI.healthBar.segments[i] = game.add.sprite(602 + (i * 9), 18, 'healthSegment',0);
                        UI.healthBar.segments[i].fixedToCamera = true;
                    }
                    
                    gameCamera.follow(player.playerBody,Phaser.Camera.FOLLOW_LOCKON,0.5,0.5);
                },

                update: function() {
                    var nextRoom = 0;
                    game.physics.arcade.collide(player.playerBody, platforms);
                    game.physics.arcade.collide(enemies, platforms);
                    game.physics.arcade.overlap(player.grappleBody, platforms, player.latchHook,null,player);
                    game.physics.arcade.overlap(player.playerBody,enemies, player.takeDamage ,null,player);
                    game.physics.arcade.overlap(player.playerBody,exits,function(player,exit){nextRoom = exit.roomNumber;},null,this);
                    
                    while(nextRoom == 0){
                        enemies.forEach(function(enemy){
                            enemy.wander();
                        },this);

                        player.redrawReticule();
                        player.checkAirborne();
                        player.repositionHook();
                        player.checkAttacking();
                        player.invincibilityCountdown();

                        if(player.grappleOut) {
                            player.checkTaut();
                        }

                        if(gameKeyboard.left.isDown){
                            player.moveLeft(100);
                        } else if(gameKeyboard.right.isDown){
                            player.moveRight(100);
                        } else {
                            player.rest();
                        }

                        if(gameKeyboard.up.isDown){
                            player.aimUp(Math.PI/32);
                        } else if(gameKeyboard.down.isDown){
                            player.aimDown(Math.PI/32);
                        }

                        if(gameKeyboard.space.isDown){
                            player.jump(200);
                        }

                        if(gameKeyboard.a_key.isDown){
                            player.attack(enemies);
                        }

                        if(gameKeyboard.s_key.isDown){
                            player.fireHook(500);
                        }

                        scoreText.text = 'score: ' + score + ' pts';
                        UI.healthBar.displayHealth();
                        return;
                    }
                    
                    player.reset();
                    game.state.start('room' + nextRoom);
                }
            };
            
            gameWon = {
                preload: function(){
                    
                },
                
                create: function(){
                    scoreText = game.add.text(300, game.world.height/2 - 50, 'You Win!', { fontSize: '32px', fill: '#fff' });
                },
                
                update: function(){
                    
                }
            };
            
            gameOver = {
                preload: function(){
                
                },
                
                create: function(){
                    
                },
                
                update: function(){
                    
                }
            };
            
            game.state.add('menu',menu);
            game.state.add('room1',room1);
            game.state.add('room2',room2);
            game.state.add('room3',room3);
            game.state.add('gameWon',gameWon);
            game.state.add('gameOver',gameOver);
            
            game.state.start('room1');
            
        </script>
    </head>
    <body>
        
    </body>
</html>